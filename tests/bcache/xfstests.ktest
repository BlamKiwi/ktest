#!/bin/bash

require-lib ../xfstests.sh
#require-lib bcache-test-libs.sh

require-kernel-config BCACHE
#require-kernel-config BCACHE_DEBUG
require-kernel-config COMPACTION

require-build-deb bcache-tools
require-file mkfs.bcache

antagonist_shrink()
{
    while true; do
	for file in $(find /sys/fs/bcache -name prune_cache); do
	    echo 100000 > $file
	done
	sleep 0.5
    done
}

antagonist_expensive_debug_checks()
{
    # This only exists if CONFIG_BCACHE_DEBUG is on
    p=/sys/module/bcache/parameters/expensive_debug_checks

    if [ -f $p ]; then
	while true; do
	    echo 1 > $p
	    sleep 5
	    echo 0 > $p
	    sleep 10
	done
    fi
}

antagonist_trigger_gc()
{
    while true; do
	sleep 5
	echo 1 | tee /sys/fs/bcache/*/internal/trigger_gc > /dev/null 2>&1 || true
    done
}

antagonist_switch_crc()
{
    cd /sys/fs/bcache

    while true; do
	sleep 2
	echo crc64  | tee */options/data_checksum	> /dev/null 2>&1 || true
	echo crc64 | tee */options/metadata_checksum	> /dev/null 2>&1 || true
	echo crc64 | tee */options/str_hash		> /dev/null 2>&1 || true
	#echo lz4    | tee */options/compression		> /dev/null 2>&1 || true
	sleep 2
	echo crc32c | tee */options/data_checksum	> /dev/null 2>&1 || true
	echo crc32c | tee */options/metadata_checksum	> /dev/null 2>&1 || true
	echo sha1   | tee */options/str_hash		> /dev/null 2>&1 || true
	#echo gzip   | tee */options/compression		> /dev/null 2>&1 || true
    done
}

main()
{
    ulimit -c unlimited
    #setup_tracing 'bcache:*'
    #echo 1 > /sys/module/bcache/parameters/expensive_debug_checks
    echo 1 > /sys/module/bcache/parameters/debug_check_bkeys || true
    #echo 1 > /sys/module/bcache/parameters/btree_gc_coalesce_disabled
    #echo 1 > /sys/module/bcache/parameters/key_merging_disabled

    echo "class race frequency 100" > /sys/kernel/debug/dynamic_fault/control

    (cd $LOGDIR/bcache-tools; make && make install)

    #antagonist_expensive_debug_checks &
    #antagonist_shrink &
    #antagonist_trigger_gc &
    #antagonist_switch_crc &

    # XXX: test with this
    # apt install -y stress-ng

    # fail when testing different block sizes:
    #test_xfstests bcache "generic/091 generic/114 generic/240 generic/263"

    #test_xfstests bcache "generic/019 generic/077"

    #test_xfstests bcache "generic/299"

    test_xfstests bcache "generic/???"
}
