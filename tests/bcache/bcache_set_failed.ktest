#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 512M
config-tier 2G,2G
config-bucket-size 64k
config-block-size 4k
config-volume 1400M

config-timeout $(stress_timeout)

main()
{
    setup_tracing 'bcache:*'

    setup_bcache

    bcacheadm list-cachesets --list-devs

    UUID=$(bcacheadm query-devs /dev/sdc --uuid-only)

    # unregister the cacheset
    bcacheadm unregister /dev/sdb /dev/sdc /dev/sdd
    sleep 1

    # register the cacheset again only with sdb/sdd
    bcacheadm register /dev/sdb /dev/sdd
    sleep 1

    # Check that sdc is missing after reregistering
    # Doing bcacheadm status on multiple devs ensures that we get the most
    # up to date superblock
    STATUS=$(bcacheadm status /dev/sdb /dev/sdc /dev/sdd | sed -n 3p | awk '{print $2}')
    [[ (( $STATUS = "missing" )) ]]

    bcacheadm set-failed -d $UUID

    # Check that sdc is failed
    STATUS=$(bcacheadm status /dev/sdb /dev/sdc /dev/sdd | sed -n 3p | awk '{print $2}')
    [[ (( $STATUS = "failed" )) ]]

    stop_bcache
}
