#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 2G
config-bucket-size 512k
config-block-size 2k

config-timeout 600

require-lib /src/vm-tests/container_lib.sh
require-container ioctl_test

main()
{
    setup_tracing 'bcache:*'

    setup_bcache
    sleep 1

    for i in `seq 0 100`; do
	container_run ioctl_test /dev/bcache_extent0 inode_create 2048 1
    done

    container_run ioctl_test /dev/bcache_extent0 inode_delete 99
    container_run ioctl_test /dev/bcache_extent0 inode_delete 98

    container_run ioctl_test /dev/bcache_extent0 inode_create 2048 1
}
