#!/bin/bash

require-lib bcache-test-libs.sh

require-lib ../../../vm-tests/container_lib.sh
require-container ioctl_test

config-cache 1G
config-bucket-size 64k
config-block-size 2k
config-mem 512M

config-timeout 600

main()
{
    copy_containers

    setup_bcache

    cd /root

    dd if=/dev/urandom of=foo bs=4096 count=1

    bch_ioctl()
    {
	container_run ioctl_test /dev/bcache_extent0 $@
    }

    bch_ioctl write	0 0	    8 < foo
    bch_ioctl copy	0 0   1 0   8
    bch_ioctl read	1 0	    8 > bar

    diff -q foo bar
}
