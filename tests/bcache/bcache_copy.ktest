#!/bin/bash

require-lib ../test-libs.sh

require-lib ../../../vm-tests/container_lib.sh
require-container ioctl_test

config-scratch-devs 1G
config-mem 256M

config-timeout 600

main()
{
    copy_containers

    make-bcache --bucket 64k --block 2k --cache /dev/vda
    echo /dev/vda > /sys/fs/bcache/register

    cd /root

    dd if=/dev/urandom of=foo bs=4096 count=1

    bch_ioctl()
    {
	container_run ioctl_test /dev/bcache_extent0 $@
    }

    bch_ioctl write	0 0	    8 < foo
    bch_ioctl copy	0 0   1 0   8
    bch_ioctl read	1 0	    8 > bar

    diff -q foo bar
}
