#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 512M
config-tier 2G
config-scratch-devs 1G,1G

config-bucket-size 512k
config-block-size 2k

config-volume 1400M

config-timeout $(stress_timeout)

main()
{
    setup_tracing 'bcache:*'

    setup_bcache
    echo "setup done"

    (
	sleep 5
	make-bcache --bucket 512k --block 2k --tier 1 -C /dev/sdd
	echo "adding device 1"
	echo /dev/sdd > /sys/fs/bcache/*/add_device

	sleep 5
	make-bcache --bucket 512k --block 2k --tier 1 -C /dev/sde
	echo "adding device 2"
	echo /dev/sde > /sys/fs/bcache/*/add_device

	# can't start test_antagonist before adding the device, because it will
	# triggers dynamic faults in the background which breaks a kmalloc adding
	# the device
	test_antagonist
    ) &

    test_fio
    test_discard

    # Make sure we actually added those devices
    devices="$(ls -d /sys/fs/bcache/*/cache[0-9] | wc -l)"
    if [ "$devices" != 4 ]; then
	echo "Only found $devices devices"
	exit 1
    fi

    # Make sure new devices are in tier 1
    for device in cache2 cache3; do
	tier="$(cat /sys/fs/bcache/*/${device}/tier)"
	if [ "$tier" != 1 ]; then
	    echo "${device} not in tier 1"
	    exit 1
	fi
    done

    stop_bcache
}
