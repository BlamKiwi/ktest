#!/bin/bash

require-lib bcache-test-libs.sh

require-kernel-config BLK_DEV_MD,MD_FAULTY

config-cache 512M
config-tier 2G,2G

config-bucket-size 64k
config-block-size 4k
config-volume 1400M

config-timeout $(stress_timeout)

main()
{
    setup_tracing 'bcache:*'

    parsed=(`echo $TIER | tr ' ' '\n'`)

    mdadm -B /dev/md0 -lfaulty -n1 ${parsed[0]}
    TIER="/dev/md0 ${parsed[1]}"

    (
	sleep 10
	# mdadm -G /dev/md0 -pwrite-transient40
	mdadm -G /dev/md0 -pread-persistent1
    )&

    setup_bcache
    echo readonly > /sys/fs/bcache/*/errors

    test_antagonist
    test_stress || true
    stop_volumes
    test_bcachefs_stress
    stop_bcache
}
