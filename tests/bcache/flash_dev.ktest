#!/bin/bash

require-lib bcache-test-libs.sh

# XXX possibly broken with 1 mb buckets
config-cache 2150MB
config-bucket-size 2M

#config-cache 2G
#config-bucket-size 512k

config-block-size 2k
config-volume 1800M

config-timeout $(stress_timeout)

main()
{
    echo 1 > /sys/module/bcache/parameters/debug_check_bkeys
    setup_tracing 'bcache:*'

    setup_bcache
    #existing_bcache

    run_antagonist
    run_bcache_stress
    #run_fio

    stop_volumes
    run_bcachefs_stress
    stop_bcache
}
