#!/bin/bash

require-lib ../test-libs.sh

config-scratch-devs 512M,512M,512M,512M
config-mem 512M

config-timeout 600

main()
{
    SIZE=small
    FS=ext4
    FLAGS="--bucket 64k --block 4k --discard --writeback --cache_replacement_policy=lru"
    CACHE="/dev/vda /dev/vdb"
    BDEV=
    TIER="/dev/vdc /dev/vdd"
    VOLUME=500M

    setup_tracing 64 'bcache:*'

    setup_bcache
    echo 2 > /sys/fs/bcache/*/data_replicas

    (
	sleep 10
	echo "removing device 3"
	echo 1 > /sys/fs/bcache/*/cache3/unregister
	echo "removed"
    )&

    test_stress
    stop_bcache
}
