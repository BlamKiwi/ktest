#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 512M,512M
config-tier 512M,512M
config-bucket-size 64k
config-block-size 4k
config-volume 500M
config-mem 512M
config-data-replicas 2

config-timeout $(stress_timeout)

main()
{
    setup_tracing 'bcache:*'

    setup_bcache

    (
	sleep 10
	echo "removing device 3"
	echo 1 > /sys/fs/bcache/*/cache3/unregister
	echo "removed"
    )&

    test_antagonist
    test_stress
    stop_bcache
}
