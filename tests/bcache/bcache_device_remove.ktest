#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 512M,512M
config-tier 512M,512M,512M
config-bucket-size 64k
config-block-size 4k
config-volume 350M
config-data-replicas 2

config-timeout $(stress_timeout)

main()
{
    setup_tracing 'bcache:*'

    setup_bcache

    DEVNAME=`ls -d /sys/fs/bcache/*/cache4`

    (
	# 1. Wait until test_fio is going.
	sleep 10

	# 2. Remove the tier 1 device -- everyting live
	# should move to other devices

	echo "Removing device $DEVNAME"
	echo 1 > $DEVNAME/unregister

	COUNTER=0

	while [ $COUNTER -lt 60 ]; do
	    let COUNTER=COUNTER+1
	    if [ -a $DEVNAME ]; then
		sleep 1
	    else
	    	echo "Device $DEVNAME removed"
		break
	    fi
	done

    )&

    test_antagonist
    test_fio

    SUCCESS=1

    if [ -a $DEVNAME ]; then
	SUCCESS=0
    fi

    stop_bcache

    if [ $SUCCESS -eq 0 ]; then
	exit 1
    fi
}
