#!/bin/bash

require-lib ../test-libs.sh

config-scratch-devs 2G,4G
config-mem 512M
config-cpus 1

nr_iterations=$((($ktest_priority + 1) * 5))
config-timeout $(($nr_iterations * 60))

main()
{
    SIZE=small
    FS=ext4
    FLAGS="--bucket 32k --block 4k --discard --writeback --cache_replacement_policy=lru"
    CACHE="/dev/vda"
    BDEV=
    TIER="/dev/vdb"
    VOLUME=1600M

    setup_tracing 64 'bcache:*'

    if [ $NR_REBOOTS = 0 ]; then
	setup_bcache
    else
	existing_bcache
    fi

    [ "$NR_REBOOTS" != "$nr_iterations" ] && (sleep 10; do_reboot) &

    test_sysfs

    test_shrink &
    test_fault &
    test_sync &
    test_drop_caches &

    if [ "$NR_REBOOTS" != "$nr_iterations" ]; then
	test_fio || true
	sleep 1000
	exit 1
    else
	test_fio
	stop_bcache
    fi
}
