#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 2G
config-bucket-size 64k
config-block-size 2k

nr_iterations=$((($ktest_priority + 1) * 5))
config-timeout $(($nr_iterations * 60))

main()
{
    setup_tracing 'bcache:*'

    if [ $NR_REBOOTS = 0 ]; then
	setup_bcache
    else
	existing_bcache
    fi

    setup_bcachefs

    test_antagonist

    [ "$NR_REBOOTS" != "$nr_iterations" ] && (sleep 10; do_reboot) &

    test_dbench || true

    if [ "$NR_REBOOTS" != "$nr_iterations" ]; then
	# Make sure we reboot and don't just exit
	while true; do
	    sleep 1000
	done
    fi
}
