#!/bin/bash

require-lib ../test-libs.sh

config-scratch-devs 2G,4G
config-mem 512M

nr_iterations=$((($ktest_priority + 1) * 5))
config-timeout $(($nr_iterations * 60))

main()
{
    SIZE=large
    FS=ext4
    FLAGS="--bucket 32k --block 4k --discard --writeback --cache_replacement_policy=lru"
    CACHE="/dev/vda"
    BDEV="/dev/vdb"
    TIER=

    setup_tracing 64 'bcache:*'

    if [ $NR_REBOOTS = 0 ]; then
	setup_bcache

	mkdir /mnt/bcache0
	mkfs.ext4 /dev/bcache0
    else
	echo /dev/vda > /sys/fs/bcache/register
	echo /dev/vdb > /sys/fs/bcache/register

	cache_set_settings
    fi

    [ $NR_REBOOTS = $nr_iterations ] && exit 0

    mount /dev/bcache0 /mnt/bcache0 -t ext4 -o errors=panic

    test_sysfs

    test_shrink &
    test_fault &
    test_sync &
    test_drop_caches &

    test_dbench &
    test_bonnie &

    sleep 30
    do_reboot
}
