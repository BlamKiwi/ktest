#!/bin/bash

require-lib bcache-test-libs.sh

config-cache	    512M,512M
config-tier	    2G,2G
config-bucket-size  64k
config-block-size   4k
config-volume	    3500M

config-timeout $(stress_timeout)

main()
{
    echo 1 > /sys/module/bcache/parameters/debug_check_bkeys

    setup_tracing 'bcache:*'
    (cd $LOGDIR/bcache-tools; make && make install)

    setup_bcache
    test_antagonist
    test_bcache_stress
    stop_bcache

    sleep 5
    existing_bcache
    test_bcache_stress
    stop_bcache

    test_bcachefs_stress
}
