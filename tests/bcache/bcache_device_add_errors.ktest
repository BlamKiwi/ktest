#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 2G
config-tier 4G
config-scratch-devs 1G
config-bucket-size 32k
config-block-size 4k
config-timeout 300
config-volume 1600M

test_faults()
{
    control=/sys/kernel/debug/dynamic_fault/control
    grep $1 $control
    echo

    for id in {0..99}; do
	fault="$1 index $id"

	echo "class $fault enable" > $control || break

	echo "TESTING FAULT $id"

	echo "Registering sdd"
	echo /dev/sdd > /sys/fs/bcache/*/add_device || true
	sleep 2

	# Make sure we didn't actually added this device
	devices="$(ls -d /sys/fs/bcache/*/cache[0-9] | wc -l)"
	if [ "$devices" != 2 ]; then
	    echo "Found $devices devices"
	    exit 1
	fi

	sleep 2
	echo "class $fault disable" > $control
	sleep 2
    done
}

main()
{
    setup_tracing 'bcache:*'

    setup_bcache

    bcacheadm format --bucket=32k --block=4k -C /dev/sdd

    echo readonly > /sys/fs/bcache/*/errors

    test_faults "bcache:add"
    test_faults "bcache:cache_set_init:cache_alloc"
    test_faults "bcache:cache_set_init:alloc_start"
    test_faults "bcache:cache_set_init:read_super"
}
