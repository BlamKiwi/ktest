#!/bin/bash

require-lib bcache-test-libs.sh

config-scratch-devs 512M,2G,2G
config-mem 512M

config-timeout 60

main()
{
    setup_tracing 64 'bcache:*'

    make-bcache -C /dev/vda /dev/vdb /dev/vdc
    make-bcache --wipe-bcache -C /dev/vdc

    echo /dev/vda > /sys/fs/bcache/register

    # Make sure we can write to sysfs without panicing
    echo 100M > /sys/fs/bcache/*/flash_vol_create || true

    # Make sure we can read from sysfs without panicing
    test_sysfs

    echo /dev/vdb > /sys/fs/bcache/register
    echo > /sys/fs/bcache/*/unregister

    echo /dev/vdc > /sys/fs/bcache/register
    echo > /sys/fs/bcache/*/unregister

    echo > /sys/fs/bcache/reboot
}
