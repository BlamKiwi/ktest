#!/bin/bash

require-lib ../test-libs.sh

config-scratch-devs 512M,2G,2G
config-mem 256M

config-timeout 60

main()
{
    SIZE=small
    FS=ext4
    FLAGS="--bucket 64k --block 4k --discard --writeback --cache_replacement_policy=lru"
    CACHE="/dev/vda"
    BDEV="/dev/vdb /dev/vdc"
    TIER=

    setup_tracing 64 'bcache:*'

    setup_bcache

    echo "we should only have one extent device"
    [ "$(ls /dev/bcache_extent* | wc -l)" -eq "1" ]

    for file in /sys/block/*/bcache/{stop,detach}; do
	if [ -f $file ]; then
	    echo > $file || true
	fi
    done

    echo "unregister"
    echo > /sys/fs/bcache/*/unregister
    sleep 5

    echo "cache set should go away"
    ls /sys/fs/bcache/*-*-* && false

    echo "extent device should go away"
    ls /dev/bcache_extent* && false

    echo "we should be able to register again"
    setup_bcache

    echo "we should only have one extent device"
    [ "$(ls /dev/bcache_extent* | wc -l)" -eq "1" ]
}
