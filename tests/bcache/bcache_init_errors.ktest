#!/bin/bash

require-lib bcache-test-libs.sh

require-kernel-config DYNAMIC_FAULT

config-scratch-devs 2G,4G
config-cache 2G
config-tier 4G
config-bucket-size 32k
config-block-size 4k
config-mem 512M
config-timeout 300
config-volume 1600M

main()
{
    setup_tracing 64 'bcache:*'

    if [ $NR_REBOOTS = 0 ]; then
	setup_bcache
	setup_fs

	test_sysfs

	test_shrink &
	test_sync &
	test_drop_caches &

	test_dbench &
	test_bonnie &

	sleep 10
	do_reboot
    else
	for id in {0..99}; do
	    control=/sys/kernel/debug/dynamic_fault/control
	    fault=cache_set_init_$id

	    grep -q $fault $control || exit 0

	    echo "TESTING FAULT $id"
	    echo "func $fault +f" > $control

	    echo /dev/vda > /sys/fs/bcache/register || true
	    echo /dev/vdb > /sys/fs/bcache/register || true

	    sleep 2
	    echo "func $fault -f" > $control
	    sleep 2

            if test -e /sys/fs/bcache/*-*-*-*-*; then
                echo "Registration should have failed"
                false
            fi
	done
    fi
}
