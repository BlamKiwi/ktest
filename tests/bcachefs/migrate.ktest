#!/bin/bash

require-lib bcachefs-test-libs.sh

require-kernel-config XFS_FS
require-kernel-config BTRFS_FS

config-scratch-devs 2G
config-timeout 60

migrate_from_fs()
{
    fstype=$1

    if [[ $fstype = ext4 ]]; then
	mkfs.$fstype -F /dev/sdb
	mount -o user_xattr /dev/sdb /mnt
    else
	mkfs.$fstype -f /dev/sdb
	mount /dev/sdb /mnt
    fi

    cp -a /usr /mnt

    for i in /mnt/usr/bin/*; do
	ln $i ${i}-migrate2
	setfattr -n user.foo -v test $i 
    done

    dd if=/dev/zero of=/mnt/bcachefs bs=1M count=512 oflag=direct
    sync

    bcachefs migrate			\
	--encrypted			\
	--no_passphrase			\
	-F -f /mnt | tee /root/migratelog
    offset=$(grep -oE 'sb=[[:digit:]]+' /root/migratelog|sed -e 's/sb=//')

    if true; then
	mkdir -p /mnt2
	mount -t bcachefs -o noexcl,nochanges,sb=$offset /dev/sdb /mnt2

	rsync	--archive		\
	    --acls			\
	    --xattrs			\
	    --checksum			\
	    --exclude=/bcachefs	    	\
	    --dry-run			\
	    --itemize-changes	    	\
	    /mnt/ /mnt2/ |tee /root/rsynclog

	umount /mnt2
	echo "rsync passed"
    fi

    umount /mnt
    fsck.$fstype -n /dev/sdb

    echo "Attempting to mount bcachefs filesystem with superblock offset"

    mount -t bcachefs -o sb=$offset /dev/sdb /mnt
    #rm /mnt/old_migrated_filesystem
    umount /mnt

    echo "Creating default superblock"

    bcachefs migrate-superblock -d /dev/sdb -o $offset
    mount -t bcachefs /dev/sdb /mnt
    umount /mnt
}

test_migrate_from_ext4()
{
    migrate_from_fs ext4
}

test_migrate_from_xfs()
{
    migrate_from_fs xfs
}

test_migrate_from_btrfs()
{
    migrate_from_fs btrfs
}

test_migrate_from_bcachefs()
{
    migrate_from_fs bcachefs
}
