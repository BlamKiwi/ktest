#!/bin/bash

require-lib bcachefs-test-libs.sh

config-timeout $(stress_timeout)

require-kernel-config MD,BLK_DEV_DM,DM_LOG_WRITES

config-scratch-devs 2G
config-scratch-devs 8G
config-scratch-devs 2G

test_writelog()
{
    cd $LOGDIR
    ln -s $LOGDIR/log-writes/replay-log /usr/bin

    dmsetup create log --table "0 $(blockdev --getsz /dev/sdb) log-writes /dev/sdb /dev/sdc"

    bcachefs format -f --btree_node=16k --error_action=panic /dev/mapper/log
    dmsetup message log 0 mark mkfs

    mount /dev/mapper/log /mnt
    fs_mark -v -n 10000 -s 4096 -k -S 0 -D  1000 -N 1000 -d /mnt -t 10
    umount /mnt

    dmsetup remove log

    nr_entries=$(replay-log --log /dev/sdc|cut -d= -f4)
    nr_flush=$(replay-log --log /dev/sdc --list --start-mark mkfs --next-flush --next-fua|wc -l)
    echo "Replaying $nr_flush/$nr_entries entries:"

    dd if=/dev/zero of=/dev/sdb 2>/dev/null || true

    prev=0
    for e in $(replay-log --log /dev/sdc --list --start-mark mkfs --next-flush --next-fua); do
	echo "testing entry $e"

	replay-log --log /dev/sdc --replay /dev/sdb --start $prev --limit $(( $e - $prev + 1))
	prev=$(( $e + 1 ))

	dmsetup create snap --table "0 $(blockdev --getsz /dev/sdb) snapshot /dev/sdb /dev/sdd N 8"
	mount -o ro /dev/mapper/snap /mnt
	umount /mnt
	dmsetup remove snap
    done
}
