#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 512M
config-tier 512M
config-bucket-size 64k
config-block-size 4k
config-volume 1400M
config-scratch-devs 512M

config-timeout 300

NUM_LINES=0

num_lines()
{
    NUM_LINES=$(bcacheadm list-cachesets --list-devs | wc -l)
}

main()
{
    setup_tracing 'bcache:*'

    setup_bcache

    CSETUUID=`bcacheadm list-cachesets`
    set -e
    for i in {1..10}; do
        bcacheadm format --csum-type=crc32c --bucket=64k --block=4k --cache_replacement_policy=lru --discard --wipe-bcache --data-replicas=1 --meta-replicas=1 --tier=1  --cache=/dev/sdd --cset-uuid=$CSETUUID
        bcacheadm add-devs /dev/sdd

        bcacheadm list-cachesets --list-devs
        num_lines
        [[ (( $NUM_LINES = 4 )) ]]

        # bcache device removal is async, wait for bcache to report that
        # removal was successful
        bcacheadm rm-dev /dev/sdd

        # sleep until there are only 3 devices present
        num_lines
        while [[ (( $NUM_LINES != 3 )) ]]
        do
            sleep 1
            num_lines
        done
    done

    stop_bcache
}
