#!/bin/bash

require-lib bcache-test-libs.sh

config-cache 1G
config-tier 2G
config-bucket-size 256k
config-block-size 4k
config-timeout 2400
config-volume 1400M

main()
{
    setup_tracing 'bcache:*'

    control=/sys/kernel/debug/dynamic_fault/control

    # Test metadata write faults
    grep "bcache:meta:write" $control
    echo

    for id in {0..99}; do
	echo "TESTING FAULT $id"

	fault="bcache:meta:write index $id"

	setup_bcache
	echo readonly > /sys/fs/bcache/*/errors

	echo "class $fault enable" > $control || break

	# Should fail due to read only cache set
	! run_fio

	echo "class $fault disable" > $control

	/cdrom/bcacheadm unregister

	sleep 5
    done

    stop_bcache
}
