#!/bin/bash

require-lib bcache-test-libs.sh

require-file mkfs.bcache
require-file xfstests

require-kernel-config FAULT_INJECTION,FAULT_INJECTION_DEBUG_FS,FAIL_MAKE_REQUEST
require-kernel-config BLK_DEV_DM,DM_FLAKEY
require-kernel-config USER_NS

require-kernel-config 64BIT=y

#require-file util-linux-2.27~rc1
#require-file linux-3.13.tar

config-cache 2G
config-bucket-size 16k
config-block-size 512
config-volume 1400M

config-timeout $(stress_timeout)

#config-scratch-devs 11G
config-scratch-devs 2G

main()
{
    useradd fsgqa

    export TEST_DEV=/dev/sdb
    export TEST_DIR=/mnt/bcachefs
    export FSTYP=ext4
    export SCRATCH_DEV=/dev/sdc
    export SCRATCH_MNT=/mnt/scratch

    mkdir -p $TEST_DIR $SCRATCH_MNT

    mkfs.ext4 $TEST_DEV
    mount $TEST_DEV $TEST_DIR

    cp -a /cdrom/xfstests /root
    cd /root/xfstests
    #make clean && make

    ln -sf /bin/bash /bin/sh

    # stress tests:
    while true; do
	./check generic/127

	#./check generic/019 generic/075 generic/083	\
	#    generic/113 generic/130 generic/269 generic/316

	#./check generic/059 generic/075 generic/091	\
	#    generic/112 generic/127 generic/263	\
	#    generic/313 generic/316

	#./check generic/???
    done
}
