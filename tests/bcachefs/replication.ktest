#!/bin/bash

require-lib bcachefs-test-libs.sh

require-kernel-config BLK_DEV_MD
require-kernel-config MD_FAULTY

config-scratch-devs 4G
config-scratch-devs 4G

config-timeout $(stress_timeout)

test_twodevices()
{
    run_basic_fio_test			\
	/dev/sdb /dev/sdc
}

test_replicas()
{
    run_basic_fio_test			\
	--metadata_replicas=2		\
	--data_replicas=2		\
	/dev/sdb /dev/sdc
}

do_remove_test()
{
    offline=$1

    bcachefs format			\
	--error_action=panic		\
	--metadata_replicas=2		\
	--data_replicas=2		\
	/dev/sdb /dev/sdc >/dev/null

    mount -t bcachefs /dev/sdb:/dev/sdc /mnt

    run_fio_randrw >/dev/null &
    sleep 1

    echo -n "failing /dev/sdb... "
    bcachefs device set-state --force	/mnt 0 failed
    echo "done"

    if [[ $offline = 1 ]]; then
	echo -n "offlining /dev/sdb... "
	bcachefs device offline		/mnt 0
	echo "done"
    fi

    echo -n "removing /dev/sdb... "
    bcachefs device remove --force	/mnt 0
    echo "done"

    wait
    umount /mnt

    mount -t bcachefs /dev/sdc /mnt
    umount /mnt
}

test_device_remove_offline()
{
    do_remove_test 1
}

test_device_remove_online()
{
    do_remove_test 0
}

test_device_add()
{
    setup_tracing 'bcachefs:*'

    bcachefs format			\
	--error_action=panic		\
	/dev/sdb >/dev/null

    mount /dev/sdb /mnt

    if false; then
	run_fio_randrw >/dev/null &
    fi

    echo -n "adding /dev/sdc... "
    bcachefs device add /mnt /dev/sdc
    echo "done"

    wait
    umount /mnt
    mount -t bcachefs /dev/sdb:/dev/sdc /mnt

    echo -n "removing /dev/sdc... "
    bcachefs device set-state /mnt /dev/sdc failed
    bcachefs device remove /mnt /dev/sdc
    echo "done"

    umount /mnt

    mount /dev/sdb /mnt
    echo -n "readding /dev/sdc... "
    bcachefs device add /mnt /dev/sdc
    echo "done"
    umount /mnt
}

do_replicas_errors_test()
{
    error_type=$1

    bcachefs_antagonist

    mdadm -B /dev/md0 -lfaulty -n1 /dev/sdc

    bcachefs format			\
	--error_action=panic		\
	--metadata_replicas=2		\
	--data_replicas=2		\
	/dev/md0 /dev/sdb >/dev/null

    mount -t bcachefs -o degraded /dev/sdb:/dev/md0 /mnt

    mdadm -G /dev/md0 -p$error_type

    run_fio_randrw
    umount /mnt
    mdadm --stop /dev/md0
}

test_replicas_write_errors()
{
    do_replicas_errors_test write-all
}

test_replicas_read_errors()
{
    do_replicas_errors_test read-persistent1
}
