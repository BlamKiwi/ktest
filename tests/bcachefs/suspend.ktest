#!/bin/bash

require-lib bcachefs-test-libs.sh

config-scratch-devs 2G
config-timeout $(stress_timeout)

require-kernel-config	PM,SUSPEND,PM_SLEEP,PM_DEBUG
require-kernel-append	no_console_suspend

test_suspend()
{
    umount $LOGDIR

    #setup_tracing 'bcachefs:*'

    (
	p="/sys/power"

	sleep 10
	echo freezer	> $p/pm_test
	echo freeze	> $p/state

	#echo 1 > /sys/fs/bcachefs/suspend
	#s2ram --no_kms --force
    )&

    bcachefs format /dev/sdb
    mount /dev/sdb /mnt

    if false; then
	run_dbench
    else
	run_antagonist
	run_stress
    fi
}
